---
title: "AWS CDKでFargateなECSクラスタを30分で立てる"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['aws','cdk','fargate','ecs','rails','typescript']
published: false
---

## はじめに
AWS Dev Dayを色々見ていたら、やけにCDKを推している感じがあり、今Terraformで管理しているインフラもCDKに以降できたら開発チームでもインフラ管理しやすくなるかなぁと思い、ちょっと試してみた感じです。

## AWS CDKとは
2019年7月にGAとなった、AWSリソースを既存の開発言語で定義することができるフレームワークです。
GA当初は2種類のみだったサポート言語も、2020年11月現在では
- TypeScript
    - JavaScript
- Python
- Java
- C#

の5種類となります。

バックエンドにはCloudFormationが作られるので、Web上のAWSコンソールからもGUIを用いて確認することができます。

## aws-cdkコマンドをインストール
早速やっていきます。

プロジェクトの初期化や、テンプレートの確認、実際のデプロイなどにはAWS CDKで用意されたコマンドが必要になるので、まずはこちらをインストールしていきます。

今回は対象のマシンはMac前提で書いていきます。

公式にはnpmでのインストールが書いてあるんですが、どうも色んなマシンで開発をしていると、どのプロジェクトがnpmでどのプロジェクトがyarnなのか分からなくなることがあり、brewとかにないのかなと思ったらあったので今回はbrewでインストールします。

もちろん公式の通り、npmでも（yarnでも）構わないと思います。

```shell script
$ brew install aws-cdk
```

https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html#getting_started_install

## init
インストールができたところで、プロジェクトの初期化を行っていきます。

とは言えまだプロジェクトのディレクトリすらないので作っておきます。

```shell script
$ mkdir cdk-sample && cd $_
```

ディレクトリを移動したところで、まずは `cdk init` だけ打って説明を見てみましょう。

```shell script
$ cdk init
  Available templates:
  * app: Template for a CDK Application
     └─ cdk init app --language=[csharp|fsharp|java|javascript|python|typescript]
  * lib: Template for a CDK Construct Library
     └─ cdk init lib --language=typescript
  * sample-app: Example CDK Application with some constructs
     └─ cdk init sample-app --language=[csharp|fsharp|java|javascript|python|typescript]
```

テンプレートを選べと。

`app` `lib` `sample-app` から選ぶようです。

`cdk init --help` で見ると色々とオプションはあるんですが、ここに示されているのは `--language` だけなのでまずはシンプルに行ってみましょう。

```shell script
$ cdk init sample-app --language=typescript
Applying project template sample-app for typescript
# Welcome to your CDK TypeScript project!

You should explore the contents of this project. It demonstrates a CDK app with an instance of a stack (`CdkSampleStack`)
which contains an Amazon SQS queue that is subscribed to an Amazon SNS topic.

The `cdk.json` file tells the CDK Toolkit how to execute your app.

## Useful commands

 * `npm run build`   compile typescript to js
 * `npm run watch`   watch for changes and compile
 * `npm run test`    perform the jest unit tests
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk synth`       emits the synthesized CloudFormation template

Initializing a new git repository...
Executing npm install...
~~~~~~

✅ All done!
```

こんな感じで完了しました。

今後使っていくであろうコマンドも表示されているので、さっと目を通しておきます。
```shell script
 * `npm run build`   compile typescript to js
 * `npm run watch`   watch for changes and compile
 * `npm run test`    perform the jest unit tests
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk synth`       emits the synthesized CloudFormation template
```

## 一旦デプロイしてみる
デプロイ手順は本当に簡単で、コマンドを2つほど叩くだけです。

まずはこちら。
```shell script
$ cdk synth
```

こちらは現在の定義でどんなリソースがどう作られるかを確認するコマンドです。

出力結果は長いので全部は載せられませんがこんな感じ。

```shell script
$ cdk synth
Resources:
  CdkSampleQueue5EE69D51:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
    Metadata:
      aws:cdk:path: CdkSampleStack/CdkSampleQueue/Resource
  CdkSampleQueuePolicyF9F8BD75:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sqs:SendMessage
            Condition:
~~~~~
```
前半部分だけですが、AWS SQSのキューとそこで使われるポリシーが作られるようです。

その後、リソースに問題はない（サンプルなので問題あるかどうかまでわかんないですけど）ので、いよいよデプロイします。

コマンドは `cdk deploy` です。

```shell script
$ cdk deploy
This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).
Please confirm you intend to make the following modifications:

IAM Statement Changes
┌───┬───────────────────────┬────────┬─────────────────┬───────────────────────────┬───────────────────────────────────────────────────────┐
│   │ Resource              │ Effect │ Action          │ Principal                 │ Condition                                             │
├───┼───────────────────────┼────────┼─────────────────┼───────────────────────────┼───────────────────────────────────────────────────────┤
│ + │ ${CdkSampleQueue.Arn} │ Allow  │ sqs:SendMessage │ Service:sns.amazonaws.com │ "ArnEquals": {                                        │
│   │                       │        │                 │                           │   "aws:SourceArn": "${CdkSampleTopic}"                │
│   │                       │        │                 │                           │ }                                                     │
└───┴───────────────────────┴────────┴─────────────────┴───────────────────────────┴───────────────────────────────────────────────────────┘
(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

Do you wish to deploy these changes (y/n)? 
```

「変更内容合ってるかー？」と聞いてくれるので `y` を。

```shell script
CdkSampleStack: deploying...
CdkSampleStack: creating CloudFormation changeset...
[██████████████████████████████████████████████████████████] (6/6)


 ✅  CdkSampleStack

Stack ARN:
arn:aws:cloudformation:ap-northeast-1:611036819457:stack/CdkSampleStack/d5108ff0-1de9-11eb-8873-0a4084594d18
```

そうしたらこのようにデプロイできたよーと教えてくれます。

ここでWebコンソールで確認してみると、確かに出来ているようです。

## 削除しておこう
このアプリケーションを残しておく意味もないので消しておきましょう。

```shell script
$ cdk destroy
Are you sure you want to delete: CdkSampleStack (y/n)?
```

またもやちゃんと確認を取ってくれます。親切ですね。 `y` です。

```shell script
CdkSampleStack: destroying...
0:38:27 | DELETE_IN_PROGRESS   | AWS::CloudFormation::Stack | CdkSampleStack
0:38:31 | DELETE_IN_PROGRESS   | AWS::SQS::Queue        | CdkSampleQueue

 ✅  CdkSampleStack: destroyed
```

今回もちゃんと絵文字を使って完了を教えてくれました。

## FargateなECSを作ろう
さてここからが本題のリソースです。長かった。

AWS CDKは、普段開発している言語で書けるということは、勝手に欲しいライブラリがimportされるようなことはありません。

なので、欲しい機能はそれぞれインストールしてimportしてやる必要があります。

今回必要となるのは

- @aws-cdk/aws-ec2

https://docs.aws.amazon.com/cdk/api/latest/docs/aws-ecs-patterns-readme.html

## cdk synth

## cdk deploy

## cdk destroy

## 解説

### スタック
### 

